using System;
using System.Timers;
using System.Text;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using Sandbox.ModAPI;
using VRage.Game.Components;
using VRage.ModAPI;
using VRage.ObjectBuilders;
using Sandbox.ModAPI.Interfaces.Terminal;
using ObjectBuilders.SafeZone;
using IMySafeZoneBlock = SpaceEngineers.Game.ModAPI.IMySafeZoneBlock;
using Sandbox.ModAPI.Interfaces;
using Sandbox.Game;


namespace SafeZoneCap
{

     public class Globals
    {
        public static bool modificationsComplete = false;  
        public static bool configLoaded = false;
        public static bool PropertyChanged = true;    
        public static float frame = 10;       
        public static bool debug = true;   
        public static bool allowChangeShape = false;
        public static float maxSafeZoneRadius = 80;

    }


#region CONFIG

    public class SZLogger
    {
        private const string LOGFILE = "SafeZoneCap.log";
        
        public static void Log(string text)
        {
            if (Globals.debug) {
                try
                {
                    
                    string timestamp = DateTime.Now.ToString("dd/MM/yyyy hh:mm:ss");
                    StringBuilder existingContent = new StringBuilder();

                    // Check if the file exists
                    if (MyAPIGateway.Utilities.FileExistsInLocalStorage(LOGFILE, typeof(SZLogger)))
                    {
                        // Read existing content if the file exists
                        using (var reader = MyAPIGateway.Utilities.ReadFileInLocalStorage(LOGFILE, typeof(SZLogger)))
                        {
                            string line;
                            while ((line = reader.ReadLine()) != null)
                            {
                                existingContent.AppendLine(line);
                            }
                        }
                    }
                    else
                    {
                        // Create the file if it does not exist
                        using (var writer = MyAPIGateway.Utilities.WriteFileInLocalStorage(LOGFILE, typeof(SZLogger)))
                        {
                            writer.Write(string.Empty);
                        }
                    }

                    // Append new content
                    existingContent.AppendLine(timestamp + ": " + text);

                    // Write combined content back to the file
                    using (var writer = MyAPIGateway.Utilities.WriteFileInLocalStorage(LOGFILE, typeof(SZLogger)))
                    {
                        writer.Write(existingContent.ToString());
                    }
                }
            catch (Exception ex)
                {
                    MyAPIGateway.Utilities.ShowNotification("SZLogger Error: " + ex.Message, 5000, MyFontEnum.Red);
                }
            }

        }
    }
    public class MySZConfig
    {
        private const string FILE = "SafeZoneCap.cfg";
        
        public static void Load()
        {
            try
            {
                if (MyAPIGateway.Utilities.FileExistsInLocalStorage(FILE, typeof(MySZConfig)))
                {
                    var file = MyAPIGateway.Utilities.ReadFileInLocalStorage(FILE, typeof(MySZConfig));
                    ReadSettings(file);
                    file.Close();
                    SZLogger.Log("Load Default-Settings loaded");
                } else {
                    Save();
                }
                Globals.configLoaded = true;
            }
           catch (Exception ex)
            {
                SZLogger.Log("Load Error in Load: " + ex.Message);
                Globals.configLoaded = false;
            }

            
        }

        private static void Save()
        {
            try
            {
                var file = MyAPIGateway.Utilities.WriteFileInLocalStorage(FILE, typeof(MySZConfig));
                file.Write(GetSettingsString());
                file.Flush();
                file.Close();
                SZLogger.Log("Save Default-Settings saved");
            }
           catch (Exception ex)
            {
                SZLogger.Log("Save Error in Load: " + ex.Message);
            }
        }

        


        private static string GetSettingsString()
        {   
            var str = new StringBuilder();

            str.Append("allow-change-shape=").Append(Globals.allowChangeShape).AppendLine();
            str.Append("max-safezone-radius=").Append(Globals.maxSafeZoneRadius).AppendLine();
            str.Append("debug=").Append(Globals.debug).AppendLine();

            SZLogger.Log("GetSettingsString Globals.allowChangeShape" + Globals.allowChangeShape.ToString());
            SZLogger.Log("GetSettingsString Globals.maxSafeZoneRadius" + Globals.maxSafeZoneRadius.ToString());
            SZLogger.Log("GetSettingsString Globals.debug" + Globals.debug.ToString());

            return str.ToString();
        }

        private static void ReadSettings(TextReader file)
        {
            try
            {
                string line;
                string[] args;
                while ((line = file.ReadLine()) != null)
                {
                    if (line.Length == 0) continue;

                    args = line.Split(new char[] { '=' }, 2);
                    if (args.Length != 2) continue;

                    args[0] = args[0].Trim().ToLower();
                    args[1] = args[1].Trim().ToLower();

                    switch (args[0])
                    {
                        case "allow-change-shape":
                            Globals.allowChangeShape = bool.Parse(args[1]);
                            break;
                        case "max-safezone-radius":
                            Globals.maxSafeZoneRadius = float.Parse(args[1]);
                            break;
                        case "debug":
                            Globals.debug = bool.Parse(args[1]);
                            break;
                    }
                }
                SZLogger.Log("ReadSettings completed");
            }
           catch (Exception ex)
            {
                SZLogger.Log("ReadSettings Error in Load: " + ex.Message);
            }
        }
    }
 
#endregion



#region SAFEZONE CAP


    [MyEntityComponentDescriptor(typeof(MyObjectBuilder_SafeZoneBlock), false, new string[] { "SafeZoneBlock"})]
    public class SafeZoneLogic : MyGameLogicComponent
    {
        private IMySafeZoneBlock myBlock;
        private MyObjectBuilder_EntityBase m_objectBuilder;

        public override void Init(MyObjectBuilder_EntityBase objectBuilder)
        {
            //if (!Globals.configLoaded) MySZConfig.InitMySZConfig();

            //if (!Globals.configLoaded) MySZConfig.Load();

            base.Init(objectBuilder);
            m_objectBuilder = objectBuilder;
            myBlock = Entity as IMySafeZoneBlock;

            MySZConfig.Load();

            //SZLogger.Log("Entity: " + (Entity != null ? Entity.ToString() : "null"));
            //SZLogger.Log("Entity Type: " + Entity.GetType().FullName);
            SZLogger.Log("Init Done: " + Entity.GetType().FullName);
            NeedsUpdate = MyEntityUpdateEnum.BEFORE_NEXT_FRAME;
            ModifyControlsAndProperties(); 
        }
        public override void UpdateOnceBeforeFrame()
        {
            Globals.frame = Globals.frame -1;
            if (Globals.frame <= 0) {
                if (myBlock?.CubeGrid?.Physics == null)
                {
                    return; 
                }

                ModifyControlsAndProperties();      // initial disabling of property and setup for UI changes
                Globals.frame =10;
            }


            NeedsUpdate = MyEntityUpdateEnum.EACH_FRAME;
        }
        public void ModifyControlsAndProperties()
        {
            // only want to run this once
            if (Globals.modificationsComplete)
            { 
                return;
            }

            Globals.modificationsComplete = true;

            MyAPIGateway.TerminalControls.CustomControlGetter -= TerminalControls_CustomControlGetter;      // in case it's already registered
            MyAPIGateway.TerminalControls.CustomControlGetter += TerminalControls_CustomControlGetter;

            ChangeValues();
            myBlock.PropertiesChanged -= OnPropertiesChanged;      // in case it's already registered
            myBlock.PropertiesChanged += OnPropertiesChanged;
            
        }

        static void TerminalControls_CustomControlGetter(IMyTerminalBlock block, List<IMyTerminalControl> controls)
        {

            if (block is IMySafeZoneBlock)
            {
                string subtype = (block as IMySafeZoneBlock).BlockDefinition.SubtypeId;

                IMyTerminalControl control_shape = controls.Find(x1 => (x1.Id == "SafeZoneShapeCombo"));
                IMyTerminalControl slider = controls.Find(x2 => (x2.Id == "SafeZoneSlider"));
                IMyTerminalControl sliderX = controls.Find(x3 => (x3.Id == "SafeZoneXSlider"));
                IMyTerminalControl sliderY = controls.Find(x4 => (x4.Id == "SafeZoneYSlider"));
                IMyTerminalControl sliderZ = controls.Find(x5 => (x5.Id == "SafeZoneZSlider"));

               
                if (Globals.allowChangeShape)
                {
                    if (control_shape != null) control_shape.Enabled = (b) => true; 
                    if (slider != null) slider.Enabled = (b) => true; 
                    if (sliderX != null) sliderX.Enabled = (b) => true; 
                    if (sliderY != null) sliderY.Enabled = (b) => true;
                    if (sliderZ != null) sliderZ.Enabled = (b) => true;
                }
                else
                {
                    if (control_shape != null) control_shape.Enabled = (b) => false; 
                    if (slider != null) slider.Enabled = (b) => false; 
                    if (sliderX != null) sliderX.Enabled = (b) => false; 
                    if (sliderY != null) sliderY.Enabled = (b) => false;
                    if (sliderZ != null) sliderZ.Enabled = (b) => false;
                }
                
            }
        }
        public void ChangeValues(){
            ChangeValueFloat("SafeZoneSlider", Globals.maxSafeZoneRadius);
            ChangeValueFloat("SafeZoneXSlider", Globals.maxSafeZoneRadius);
            ChangeValueFloat("SafeZoneYSlider", Globals.maxSafeZoneRadius);
            ChangeValueFloat("SafeZoneZSlider", Globals.maxSafeZoneRadius);

        }
        static void OnPropertiesChanged(IMyTerminalBlock block)
        {
            Globals.PropertyChanged = true;

        }
        public override void UpdateBeforeSimulation()
        {
            // if something changed the property, change it back
            if (Globals.PropertyChanged)
            {

                ChangeValues();
                Globals.PropertyChanged = false;
            }
        }
        public void LogBlockProperties ()
        {
  
            List<ITerminalProperty> properties = new List<ITerminalProperty>();
            Func<ITerminalProperty, bool> collectAll = property => true; // Example filter function to collect all properties
            
            myBlock.GetProperties(properties, collectAll);

            // Log the properties
            foreach (var property in properties)
            {
                SZLogger.Log(property.Id.ToString());
            }
        }
        public void ChangeValueFloat(string propertyID, float value)
        {
            try
            {
                float currentvalue = myBlock.GetValueFloat(propertyID);
                if (currentvalue != value) {
                    SZLogger.Log("Current " + propertyID + " value:" + currentvalue);
                    myBlock.SetValueFloat(propertyID, value);   
                }

            }catch (Exception ex)
            {
                SZLogger.Log("Exception in OnPropertiesChanged: " + ex.Message + "\n" + ex.StackTrace);
            }
        }

        public override void MarkForClose()
        {
            MyAPIGateway.TerminalControls.CustomControlGetter -= TerminalControls_CustomControlGetter;
            myBlock.PropertiesChanged -= OnPropertiesChanged;
        }
    }


#endregion
}










